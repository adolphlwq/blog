# 用户空间和内核空间

## 前言
用户空间和内核空间是将内存一部分给内核用，一部分给用户进程用，注意用户空间和用户态以及内核空间和内核态之间的区别。

## 用户空间与内核空间
>我们知道现在操作系统都是采用虚拟存储器，那么对32位操作系统而言，它的寻址空间（虚拟存储空间）为4G（2的32次方）。操心系统的核心是内核，独立于普通的应用程序，可以访问受保护的内存空间，也有访问底层硬件设备的所有权限。为了保证用户进程不能直接操作内核，保证内核的安全，操心系统将虚拟空间划分为两部分，一部分为内核空间，一部分为用户空间。针对linux操作系统而言，将最高的1G字节（从虚拟地址0xC0000000到0xFFFFFFFF），供内核使用，称为内核空间，而将较低的3G字节（从虚拟地址0x00000000到0xBFFFFFFF），供各个进程使用，称为用户空间。每个进程可以通过系统调用进入内核，因此，Linux内核由系统内的所有进程共享。于是，从具体进程的角度来看，每个进程可以拥有4G字节的虚拟空间。
> http://www.cnblogs.com/Anker/p/3269106.html

空间分配如下图所示：
![user-kernal-space](/content/images/2017/08/user-kernal-space.png)

有了用户空间和内核空间，整个linux内部结构可以分为三部分，从最底层到最上层依次是：`硬件-->内核空间-->用户空间`。如下图所示：
![sys-state](/content/images/2017/08/sys-state.png)

**注意的细节问题**：
1. 内核空间中存放的是内核代码和数据，而进程的用户空间中存放的是用户程序的代码和数据。不管是内核空间还是用户空间，它们都处于虚拟空间中。 
2. Linux使用两级保护机制：0级供内核使用，3级供用户程序使用。

## 内核态与用户态
1. 当一个任务（进程）执行系统调用而进入内核代码中执行时，称进程处于内核运行态（内核态）。此时处理器处于特权级最高的（0级）内核代码中执行。当进程处于内核态时，执行的内核代码会使用当前进程的内核栈。每个进程都有自己的内核栈。
2. 当进程在执行用户自己的代码时，则称其处于用户运行态（用户态）。此时处理器在特权级最低的（3级）用户代码中运行。当正在执行用户程序而突然被中断程序中断时，此时用户程序也可以象征性地称为处于进程的内核态。因为中断处理程序将使用当前进程的内核栈。

## Reference
- [用户空间与内核空间，进程上下文与中断上下文[总结]](http://www.cnblogs.com/Anker/p/3269106.html)
- [linux 用户空间与内核空间——高端内存详解](http://www.cnblogs.com/onlyforcloud/articles/4466454.html)